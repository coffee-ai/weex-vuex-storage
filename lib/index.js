"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var _typeof=_interopDefault(require("@babel/runtime/helpers/typeof")),_objectWithoutProperties=_interopDefault(require("@babel/runtime/helpers/objectWithoutProperties")),_objectSpread=_interopDefault(require("@babel/runtime/helpers/objectSpread")),_regeneratorRuntime=_interopDefault(require("@babel/runtime/regenerator")),_asyncToGenerator=_interopDefault(require("@babel/runtime/helpers/asyncToGenerator")),_toConsumableArray=_interopDefault(require("@babel/runtime/helpers/toConsumableArray")),_slicedToArray=_interopDefault(require("@babel/runtime/helpers/slicedToArray")),fromEntries=_interopDefault(require("object.fromentries")),Promise$1=_interopDefault(require("promise/lib/es6-extensions")),defaultIsMergeableObject=_interopDefault(require("is-mergeable-object")),WeakSet=_interopDefault(require("core-js/es6/weak-set")),WeakMap=_interopDefault(require("core-js/es6/weak-map")),getOwnPropertyDescriptors=_interopDefault(require("object.getownpropertydescriptors")),entries=_interopDefault(require("object.entries")),interceptors={},START_TYPE="start",registerInterceptor=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:START_TYPE;(interceptors[r]||(interceptors[r]=[])).push(e)},runInterceptor=function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(){var r,t,n=arguments;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.length>0&&void 0!==n[0]?n[0]:START_TYPE,t=interceptors[r]||[],e.abrupt("return",Promise.all(t));case 3:case"end":return e.stop()}},e)}));return function(){return e.apply(this,arguments)}}();function _toPropertyKey(e){var r=_toPrimitive(e,"string");return"symbol"===_typeof(r)?r:String(r)}function _toPrimitive(e,r){if("object"!==_typeof(e)||null===e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,r||"default");if("object"!==_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(e)}var rootKey="storage",USE_WHITE_TAG=1,USE_BLACK_TAG=2,moduleWeakMap=new Map,hashTagMap=new WeakMap,descriptorSet=new WeakSet,isWeexApp="undefined"!=typeof weex&&"function"==typeof weex.requireModule,storage=function(){if(isWeexApp){var e=weex.requireModule("storage"),r=function(r){return function(){for(var t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];var o=n.slice(-1),u="function"==typeof _slicedToArray(o,1)[0]?n.slice(0,-1):n;return new Promise$1(function(t,n){var a;(a=e[r]).call.apply(a,[e].concat(_toConsumableArray(u),[function(e){var r=e.result,n=e.data;return t("success"===r?n:"{}")}]))})}};return{getItem:r("getItem"),setItem:r("setItem"),removeItem:r("removeItem")}}return window.localStorage}(),isPromise=function(e){return void 0!==e&&"function"==typeof e.then},parseJSON=function(e){try{return e?JSON.parse(e):void 0}catch(e){}},normalizeNamespace=function(e){return"".concat(e.join("/"),"/")},normalizeModule=function(e){var r,t=e.commit,n=e.namespace,a=e.store;if("string"==typeof n&&a&&(r=""===n?a._modules.root:a._modulesNamespaceMap[n]))return{module:r,path:[rootKey].concat(_toConsumableArray(n.split("/").filter(function(e){return e})))};if("function"==typeof t){var o=moduleWeakMap.get(t)||{},u=o.module,i=o.moduleKey;if(i)return{module:u,path:i.split("/").filter(function(e){return e})}}return{}},defaultArrayMerge=function(e,r){return r},mergeObject=function(e,r,t){return Object.keys(r).forEach(function(n){t.isMergeableObject(r[n])&&e[n]?e[n]=merge(e[n],r[n],t):e[n]=r[n]}),e},merge=function(e,r,t){(t=t||{}).arrayMerge=t.arrayMerge||defaultArrayMerge,t.isMergeableObject=t.isMergeableObject||defaultIsMergeableObject;var n=Array.isArray(r);return n===Array.isArray(e)?n?t.arrayMerge(e,r,t):mergeObject(e,r,t):r},getStateData=function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(t){var n,a,o,u,i,s,c=arguments;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=c.length>1&&void 0!==c[1]?c[1]:[],a=normalizeNamespace(n),o=t._children,e.t1=parseJSON,e.next=6,storage.getItem(a);case 6:if(e.t2=e.sent,e.t0=(0,e.t1)(e.t2),e.t0){e.next=10;break}e.t0={};case 10:if(u=e.t0,(i=entries(o)).length){e.next=14;break}return e.abrupt("return",u);case 14:return e.next=16,Promise$1.all(i.map(function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(t){var a,o,u;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=_slicedToArray(t,2),o=a[0],u=a[1],e.t0=o,e.next=4,r(u,n.concat(o));case 4:return e.t1=e.sent,e.abrupt("return",[e.t0,e.t1]);case 6:case"end":return e.stop()}},e)}));return function(r){return e.apply(this,arguments)}}()));case 16:return s=e.sent,e.abrupt("return",_objectSpread({},u,fromEntries(s)));case 18:case"end":return e.stop()}},e)}));function r(r){return e.apply(this,arguments)}return r}(),getStateMap=function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(t){var n,a,o,u,i,s,c=arguments;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=c.length>1&&void 0!==c[1]?c[1]:[],a=c.length>2&&void 0!==c[2]?c[2]:{},o=normalizeNamespace(n),e.next=5,storage.getItem(o);case 5:if("{}"!==(u=e.sent)&&(a[o]=u),i=t._children,!(s=entries(i)).length){e.next=12;break}return e.next=12,Promise$1.all(s.map(function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(t){var o,u,i;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o=_slicedToArray(t,2),u=o[0],i=o[1],e.next=3,r(i,n.concat(u),a);case 3:case"end":return e.stop()}},e)}));return function(r){return e.apply(this,arguments)}}()));case 12:return e.abrupt("return",a);case 13:case"end":return e.stop()}},e)}));function r(r){return e.apply(this,arguments)}return r}(),getStateFromVuex=function e(r,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=normalizeNamespace(t),o=r._modulesNamespaceMap[a];!o&&t.length>1&&(o=r._modulesNamespaceMap[normalizeNamespace(t.slice(0,-1))].getChild(t[t.length-1]));if(o){var u=o,i=u._children,s=u.state,c=JSON.stringify(parseModuleState(o,s));"{}"!==c&&(n["".concat(rootKey,"/").concat(a)]=c);var p=Object.keys(i);p.length&&p.forEach(function(a){e(r,t.concat(a),n)})}return n},normalizeStateFromSnapshot=function(e,r,t){var n=normalizeNamespace([rootKey].concat(_toConsumableArray(r))),a=t[n],o=_objectWithoutProperties(t,[n].map(_toPropertyKey)),u=n.length,i="string"==typeof a&&parseJSON(a)||{};return Object.keys(o).sort(function(e,r){return e.length-r.length}).forEach(function(e){if(0===e.indexOf(n)){var r=e.slice(u).split("/").filter(Boolean),t=r.length;if(t){var a=o[e];r.reduce(function(e,r,n){return n===t-1?e[r]=parseJSON(a)||{}:e[r]||(e[r]={})},i)}}}),i},getModuleSnapshotKeys=function(e,r){var t=r.length?normalizeNamespace(r):"",n=e._modulesNamespaceMap[t],a=[];return function e(r,t){var n=r._children,o=void 0===n?{}:n;a.push(normalizeNamespace(t)),entries(o).forEach(function(r){var n=_slicedToArray(r,2),a=n[0],o=n[1];e(o,t.concat(a))})}(n,[rootKey].concat(_toConsumableArray(r))),a},descriptorFactory=function(e){return function(r,t){if(hashTagMap.has(r)){var n=hashTagMap.get(r);if((n|=e)&USE_WHITE_TAG&&n&USE_BLACK_TAG)throw new Error("can't set blacklist and whitelist at the same time in one module")}else hashTagMap.set(r,e);var a=r[t];return{enumerable:!0,configurable:!0,get:function(){var e=Object.getOwnPropertyDescriptor(r,t).get;return descriptorSet.has(e)||descriptorSet.add(e),a},set:function(e){a=e}}}},shouldWrite=descriptorFactory(USE_WHITE_TAG),forbidWrite=descriptorFactory(USE_BLACK_TAG),setState=function(e,r,t){var n=t.value;return t.value=function(){for(var e=arguments.length,r=new Array(e),t=0;t<e;t++)r[t]=arguments[t];var a=r[0],o=a.state,u=a.commit,i=n.apply(this,r);if(!isPromise(i))throw new Error("setState must decorate a promise function");return i.then(function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(r){var t,n,a,i;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=moduleWeakMap.get(u)||{},n=t.module,a=t.moduleKey,!n){e.next=5;break}return i=parseModuleState(n,o),e.next=5,storage.setItem(a,JSON.stringify(i));case 5:return e.abrupt("return",r);case 6:case"end":return e.stop()}},e)}));return function(r){return e.apply(this,arguments)}}())},t},parseModuleCommit=function e(r,t){var n=normalizeNamespace(t),a=r._children,o=(r.context||{}).commit;moduleWeakMap.set(o,{module:r,moduleKey:n}),entries(a).forEach(function(r){var n=_slicedToArray(r,2),a=n[0],o=n[1];e(o,t.concat(a))})},parseModuleState=function(e,r){var t=e._children,n=e.state,a=Object.keys(t),o=getOwnPropertyDescriptors(n),u=(hashTagMap.get(n)||USE_BLACK_TAG)&USE_WHITE_TAG;return fromEntries(entries(r).filter(function(e){var r=_slicedToArray(e,1)[0],t=(o[r]||{}).get;return!(a.some(function(e){return e===r})||u^descriptorSet.has(t))}))},setModuleState=function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(r,t,n){var a,o,u,i=arguments;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(a=i.length>3&&void 0!==i[3]&&i[3],o=t.length?normalizeNamespace(t):"",u=r._modulesNamespaceMap[o],parseModuleCommit(u,[rootKey].concat(_toConsumableArray(t))),e.t0=n,e.t0){e.next=9;break}return e.next=8,getStateData(u,[rootKey].concat(_toConsumableArray(t)));case 8:e.t0=e.sent;case 9:n=e.t0,function e(r,t){var n=r._children,o=r.state,u=r._rawModule,i=Object.keys(n);if(a){var s=(u||{}).state;if("function"==typeof s){var c=s();t=mergeObject(c,t,{isMergeableObject:defaultIsMergeableObject})}}entries(t).map(function(r){var a=_slicedToArray(r,1)[0];n[a]?(i.splice(i.indexOf(a),1),e(n[a],t[a]||{})):t.hasOwnProperty(a)&&(o[a]=t[a])}),a&&i.forEach(function(r){e(n[r],{})})}(u,n);case 12:case"end":return e.stop()}},e)}));return function(r,t,n){return e.apply(this,arguments)}}(),getState=function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(r){var t,n,a,o,u,i;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.commit,n=r.namespace,a=r.store,o=normalizeModule({commit:t,namespace:n,store:a}),u=o.module,i=o.path,!u||!i){e.next=4;break}return e.abrupt("return",getStateData(u,i));case 4:return e.abrupt("return",void 0);case 5:case"end":return e.stop()}},e)}));return function(r){return e.apply(this,arguments)}}(),getModuleMap=function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(r){var t,n,a,o,u,i;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.commit,n=r.namespace,a=r.store,o=normalizeModule({commit:t,namespace:n,store:a}),u=o.module,i=o.path,!u||!i){e.next=4;break}return e.abrupt("return",getStateMap(u,i));case 4:return e.abrupt("return",void 0);case 5:case"end":return e.stop()}},e)}));return function(r){return e.apply(this,arguments)}}(),replaceModuleState=function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(t,n,a){var o;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("object"===_typeof(a)){e.next=2;break}throw new Error("[weex-vuex-storage]: can't replaceModuleState with non-object");case 2:if(!t){e.next=7;break}return o=parseModuleState(t,a),e.next=6,storage.setItem(normalizeNamespace([rootKey].concat(_toConsumableArray(n))),JSON.stringify(o));case 6:return e.abrupt("return",Promise$1.all(entries(t._children).map(function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(t){var o,u,i;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o=_slicedToArray(t,2),u=o[0],i=o[1],e.next=3,r(i,[].concat(_toConsumableArray(n),[u]),a[u]||{});case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}},e)}));return function(r){return e.apply(this,arguments)}}())));case 7:case"end":return e.stop()}},e)}));function r(r,t,n){return e.apply(this,arguments)}return r}(),removeModuleState=function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(r,t){var n;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=getModuleSnapshotKeys(r,t),e.abrupt("return",Promise$1.all(n.map(function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(r){return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,storage.removeItem(r);case 2:case"end":return e.stop()}},e)}));return function(r){return e.apply(this,arguments)}}())));case 2:case"end":return e.stop()}},e)}));return function(r,t){return e.apply(this,arguments)}}(),loadStore=function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(r,t,n){var a,o,u,i,s,c,p,l,f,m,d,g,_,y=arguments;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(a=y.length>3&&void 0!==y[3]?y[3]:{},o=a.onlyState,u=void 0!==o&&o,i=a.reserveList,s=void 0===i?[]:i,c=a.removeList,p=void 0===c?[]:c,l=a.isReplace,f=void 0===l||l,u){e.next=8;break}return m=getModuleSnapshotKeys(r,t),d=Object.keys(n),g=Array.from(new Set(m.filter(function(e){return d.every(function(r){return r!==e})}).concat(p).filter(function(e){return s.every(function(r){return r!==e})}))),e.next=8,Promise$1.all([].concat(_toConsumableArray(g.map(function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(r){return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,storage.removeItem(r);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e)}));return function(r){return e.apply(this,arguments)}}())),_toConsumableArray(d.map(function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(r){return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",storage.setItem(r,n[r]));case 1:case"end":return e.stop()}},e)}));return function(r){return e.apply(this,arguments)}}()))));case 8:return _=normalizeStateFromSnapshot(r,t,n),e.next=11,setModuleState(r,t,_,f);case 11:case"end":return e.stop()}},e)}));return function(r,t,n){return e.apply(this,arguments)}}(),createStatePlugin=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=e.key,t=e.intercept,n=void 0===t?registerInterceptor:t,a=e.supportRegister,o=void 0!==a&&a,u=e.beforeCreate,i=void 0===u?[]:u;return r&&(rootKey=r),function(e){if(i.forEach(function(r){r.call(e,e)}),o){var r=e.registerModule,t=e.unregisterModule;e.registerModule=function(){var t=_asyncToGenerator(_regeneratorRuntime.mark(function t(n,a,o){var u,i,s;return _regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r.call(e,n,a,o),u=(o||{}).rawState,i="function"==typeof u?u():u,t.next=5,setModuleState(e,n,i);case 5:if(!i){t.next=10;break}return s=e._modulesNamespaceMap[normalizeNamespace(n)],t.next=9,replaceModuleState(s,n,i);case 9:return t.abrupt("return",t.sent);case 10:case"end":return t.stop()}},t)}));return function(e,r,n){return t.apply(this,arguments)}}(),e.unregisterModule=function(){var r=_asyncToGenerator(_regeneratorRuntime.mark(function r(n){return _regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,removeModuleState(e,n);case 2:t.call(e,n),parseModuleCommit(e._modules.root,[rootKey]);case 4:case"end":return r.stop()}},r)}));return function(e){return r.apply(this,arguments)}}()}parseModuleCommit(e._modules.root,[rootKey]);var a=getStateData(e._modules.root,[rootKey]).then(function(r){e.replaceState(merge(e.state,r))}).catch(function(){});n(a)}},startApp=runInterceptor;exports.createStatePlugin=createStatePlugin,exports.forbidWrite=forbidWrite,exports.getModuleMap=getModuleMap,exports.getState=getState,exports.getStateFromVuex=getStateFromVuex,exports.loadStore=loadStore,exports.parseModuleCommit=parseModuleCommit,exports.parseModuleState=parseModuleState,exports.removeModuleState=removeModuleState,exports.replaceModuleState=replaceModuleState,exports.setModuleState=setModuleState,exports.setState=setState,exports.shouldWrite=shouldWrite,exports.startApp=startApp;
